// Egg Grading — Best Case Scenario (Interactive Web Infographic)
// Converted to Standalone Component with Embedded CSS for Looker Studio compatibility.
// No external libraries or scripts needed for styling.

import React, { useState, useEffect } from 'react';

// ===== Brand Palette (โทนสว่างขึ้น) =====
const BRAND = {
  blue: '#2B74B5',
  redBrown: '#C97D72',
  seaGreen: '#3FB2A5',
  paper: '#FAFCFE'
};

// ===== DATA (No changes) =====
const META = { period: 'ก.พ.–ส.ค. 2025', totalDays: 184, machine: 'Nabel Oracion 6000' };
const kpiSummary = [
  { label: 'Base Case (ฟอง/ชม.)', value: '36,000', description: 'เป้าหมายหลักที่แนะนำ' },
  { label: 'Performance เฉลี่ย', value: '58.71%', description: 'ค่าเฉลี่ย 7 เดือน' },
  { label: 'ผลผลิตเฉลี่ย (ฟอง/ชม.)', value: '35,237', description: 'ตลอดช่วงการวิเคราะห์' },
  { label: 'โอกาสสำเร็จ (≥36k)', value: '43%', description: '79 จาก 184 วัน' },
];
const histogram = [
  { range: '27k–29k', days: 6 }, { range: '29k–31k', days: 5 }, { range: '31k–33k', days: 36 },
  { range: '33k–35k', days: 42 }, { range: '35k–37k', days: 49 }, { range: '37k–39k', days: 38 },
  { range: '39k–41k', days: 8 },
];
const lossImpact = [
  { range: '0 นาที', perf: '62.5%', production: '37,500' }, { range: '1–15 นาที', perf: '60.2%', production: '36,120' },
  { range: '16–30 นาที', perf: '58.8%', production: '35,280' }, { range: '31–60 นาที', perf: '56.4%', production: '33,840' },
  { range: '> 60 นาที', perf: '52.1%', production: '31,260' },
];
const basicStats = [
  { k: 'Minimum (ต่ำสุด)', v: '27,450' }, { k: 'Q1 (25%)', v: '33,291' }, { k: 'Median (50%)', v: '35,432' },
  { k: 'Mean (ค่าเฉลี่ย)', v: '35,237' }, { k: 'Q3 (75%)', v: '37,234' }, { k: 'Maximum (สูงสุด)', v: '40,920' },
];
const scenarios = [
  { title: 'Base Case (มาตรฐาน)', target: '36,000', condition: 'เล้าไข่ครบ • Loss < 20 นาที', risk: 'ต่ำ', action: 'รักษามาตรฐาน', evidence: '≥36k: 79/184 วัน (43%)', details: ['ใช้เป็นเป้าหมายหลักในวันทำงานปกติ', 'ทำได้แล้ว 43% ของวัน (79 จาก 184 วัน)', 'ลด Loss Time ต่อเนื่อง'] },
  { title: 'ลดเล้าใหญ่ 1 เล้า', target: 'ลดลงตาม Supply', condition: 'ปริมาณไข่ลด (ปลดเล้าใหญ่)', risk: 'กลาง', action: 'ปรับเป้าหมายชั่วคราว', evidence: '—', details: ['สะท้อนข้อจำกัดด้าน Supply ชั่วคราว', 'วางแผนคืนสู่ Base Case ทันทีที่ Supply กลับมา'] },
  { title: 'Loss > 30 นาที', target: '<34,000', condition: 'ขาดการบำรุง/เสียบ่อย', risk: 'สูง', action: 'บำรุง/แก้ระบบขนถาด', evidence: '—', details: ['ทำ Root-cause + PM เลนที่มีปัญหาซ้ำ', 'ย่น MTTR เพื่อลด Downtime'] },
  { title: 'Excellent Day', target: '≥38,400', condition: 'No Loss • Input เต็ม', risk: 'โอกาส', action: 'ผลักดันศักยภาพ', evidence: '—', details: ['บันทึกวิธีปฏิบัติ/กำลังคนในวันที่ดีพิเศษ', 'ย้ำสภาพแวดล้อมที่เอื้อต่อ Zero Loss'] },
];
const baseCaseReasons = ['เป็นเลขกลม จำง่าย สื่อสารสะดวก', 'อยู่ระหว่าง Median (35,432) และ Mean+0.5×SD (~36,200)', 'ปัจจุบันทำได้แล้ว 43% ของวัน (79/184 วัน)', 'ยังมีช่องให้พัฒนาเพิ่มขึ้นอย่างมีเหตุผล'];

// ===== Helpers (No changes) =====
const BAR_MAX_PX = 170, BAR_MIN_PX = 5;
function computeBarPx(days, max) {
  const safeMax = Math.max(1, max | 0);
  const ratio = Math.max(0, days) / safeMax;
  return Math.round(ratio * BAR_MAX_PX) + BAR_MIN_PX;
}

// ===== NEW: Embedded CSS Styles =====
// This component injects a <style> block into the DOM.
// All styling is self-contained here, removing the need for external CSS files or CDNs.
const EmbeddedStyles = () => (
  <style>{`
    /* General Layout */
    .infographic-container { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; color: #1e293b; background-color: #f8fafc; }
    .infographic-header { background-color: white; padding: 2rem; border-bottom: 1px solid #e2e8f0; }
    .infographic-main { padding: 1rem; }
    @media (min-width: 768px) { .infographic-main { padding: 2rem; } }
    .main-content-wrapper { display: flex; flex-direction: column; gap: 2rem; }

    /* Typography */
    .header-title { font-size: 2.25rem; font-weight: 800; color: ${BRAND.blue}; }
    .header-subtitle { font-size: 1.125rem; color: #475569; margin-top: 0.5rem; }
    .header-meta { font-size: 0.875rem; color: #64748b; margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 0.75rem; }
    .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1e293b; }
    .font-semibold { font-weight: 600; }

    /* Grid & Cards */
    .grid-container { display: grid; gap: 1.5rem; }
    .grid-cols-4 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    @media (min-width: 640px) { .grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    .grid-cols-5 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    @media (min-width: 1024px) { .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); } .grid-span-2 { grid-column: span 2; } .grid-span-3 { grid-column: span 3; } }
    .grid-cols-2 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    @media (min-width: 1024px) { .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; border: 1px solid #e2e8f0; }

    /* KPI Card Specifics */
    .kpi-card { transition: transform 0.2s ease-out; }
    .kpi-card:hover { transform: scale(1.05); }
    .kpi-card-base { border-left: 8px solid ${BRAND.blue}; box-shadow: 0 0 0 2px white, 0 0 0 4px ${BRAND.blue}; }
    .kpi-label { font-size: 0.875rem; font-weight: 500; color: #64748b; }
    .kpi-value { font-weight: 900; letter-spacing: -0.05em; margin: 0.25rem 0; color: ${BRAND.blue}; }
    .kpi-value-base { font-size: 3.75rem; }
    .kpi-value-other { font-size: 2.25rem; }
    .kpi-desc { font-size: 0.875rem; color: #475569; }

    /* Reasons Card */
    .reasons-list { list-style-type: decimal; list-style-position: inside; font-size: 1rem; display: flex; flex-direction: column; gap: 0.75rem; color: #334155; }

    /* Histogram */
    .histogram-plot { display: flex; align-items: flex-end; gap: 0.75rem; height: 16rem; border-radius: 0.5rem; background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 1rem; }
    .histogram-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .histogram-bar-label { font-size: 0.875rem; font-weight: 700; color: #334155; margin-bottom: 0.25rem; opacity: 0; transition: opacity 0.2s; }
    .histogram-bar-wrapper:hover .histogram-bar-label { opacity: 1; }
    .histogram-bar { width: 100%; border-top-left-radius: 0.375rem; border-top-right-radius: 0.375rem; transition: all 0.3s ease-out; box-shadow: inset 0 -3px 0 rgba(255,255,255,.3); }
    .histogram-range-label { font-size: 0.75rem; margin-top: 0.5rem; font-weight: 500; color: #475569; }

    /* Tables */
    .data-table { width: 100%; font-size: 1rem; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 0.75rem; }
    .data-table thead { background-color: #f1f5f9; }
    .data-table th { font-weight: 600; color: #334155; text-align: left; }
    .data-table tbody tr { border-bottom: 1px solid #e2e8f0; }
    .data-table .text-center { text-align: center; }
    .data-table .text-right { text-align: right; }
    .table-interpretation { font-size: 0.875rem; color: #475569; margin-top: 1rem; background-color: #f8fafc; padding: 0.75rem; border-radius: 0.5rem; }

    /* Scenario Table Specifics */
    .scenario-table tbody tr { cursor: pointer; transition: background-color 0.2s; }
    .scenario-table tbody tr:hover { background-color: #eff6ff; }
    .scenario-table-base-case { background-color: #dbeafe; font-weight: 700; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.6); padding: 1rem; }
    .modal-content { background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); max-width: 42rem; width: 100%; padding: 2rem; transform: scale(0.95); opacity: 0; animation: modal-fade-in 0.2s ease-out forwards; }
    @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: ${BRAND.blue}; }
    .modal-body { font-size: 1rem; color: #334155; margin-bottom: 1rem; }
    .modal-details-list { list-style-type: disc; list-style-position: inside; font-size: 1rem; display: flex; flex-direction: column; gap: 0.5rem; color: #1e293b; }
    .modal-footer { text-align: right; margin-top: 1.5rem; }
    .modal-close-button { padding: 0.5rem 1.5rem; border: none; cursor: pointer; border-radius: 0.5rem; background-color: #e2e8f0; color: #1e293b; font-weight: 600; transition: background-color 0.2s; }
    .modal-close-button:hover { background-color: #cbd5e1; }
  `}</style>
);

// ===== COMPONENTS (JSX updated to use new CSS classes) =====

function ScenarioModal({ scenario, onClose }) {
  if (!scenario) return null;
  return (
    <div className="modal-overlay" onClick={onClose} role="dialog" aria-modal="true">
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <h3 className="modal-title">{scenario.title}</h3>
        <div className="modal-body">
          <p><span className="font-semibold">เป้าหมาย:</span> {scenario.target}{/[0-9]/.test(scenario.target) ? ' ฟอง/ชม.' : ''}</p>
          <p><span className="font-semibold">เงื่อนไข:</span> {scenario.condition}</p>
        </div>
        {scenario.evidence && scenario.evidence !== '—' && <p style={{ fontSize: '0.875rem', color: '#64748b', marginBottom: '1rem' }}>
          <span className="font-semibold">หลักฐานจากข้อมูล:</span> {scenario.evidence}
        </p>}
        <ul className="modal-details-list">
          {scenario.details.map((t, i) => (<li key={i}>{t}</li>))}
        </ul>
        <div className="modal-footer">
          <button className="modal-close-button" onClick={onClose}>ปิด</button>
        </div>
      </div>
    </div>
  );
}

export default function EggGradingInfographic() {
  const [selected, setSelected] = useState(null);

  useEffect(() => {
    const onKey = (e) => { if (e.key === 'Escape') setSelected(null); };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, []);

  return (
    <div className="infographic-container">
      <EmbeddedStyles /> {/* <-- Styles are injected here! */}
      
      <header className="infographic-header">
        <h1 className="header-title">Best Case Scenario: Egg Grading</h1>
        <p className="header-subtitle">วิเคราะห์และนำเสนอเป้าหมาย Base Case ที่ 36,000 ฟอง/ชั่วโมง</p>
        <div className="header-meta">
          <span className="font-semibold">ช่วงข้อมูล:</span> {META.period} ({META.totalDays} วัน) | <span className="font-semibold">เครื่องจักร:</span> {META.machine}
        </div>
      </header>

      <main className="infographic-main">
        <div className="main-content-wrapper">
          <section className="grid-container grid-cols-4">
            {kpiSummary.map((it, idx) => (
              <div key={idx} className={`card kpi-card ${idx === 0 ? 'kpi-card-base' : ''}`}>
                <div className="kpi-label">{it.label}</div>
                <div className={`kpi-value ${idx === 0 ? 'kpi-value-base' : 'kpi-value-other'}`}>{it.value}</div>
                <div className="kpi-desc">{it.description}</div>
              </div>
            ))}
          </section>

          <div className="grid-container grid-cols-5">
            <section className="card grid-span-2">
              <h2 className="section-title">ทำไมต้อง 36,000 ฟอง/ชั่วโมง?</h2>
              <ul className="reasons-list">
                {baseCaseReasons.map((r, i) => (<li key={i}>{r}</li>))}
              </ul>
            </section>

            <section className="card grid-span-3">
              <h2 className="section-title" style={{marginBottom: '0.25rem'}}>การกระจายผลผลิต (Histogram)</h2>
              <p style={{fontSize: '0.875rem', color: '#64748b', marginBottom: '1rem'}}>ช่วงที่เกิดบ่อยสุดคือ 35k–37k สนับสนุน Base Case 36k</p>
              <div className="histogram-plot">
                {(() => {
                  const max = Math.max(...histogram.map(h => h.days), 1);
                  return histogram.map((b, i) => {
                    const barPx = computeBarPx(b.days, max);
                    const isPeak = b.days === 49;
                    return (
                      <div key={i} className="histogram-bar-wrapper">
                        <div className="histogram-bar-label">{b.days}<span style={{fontWeight: 400}}> วัน</span></div>
                        <div
                          className="histogram-bar"
                          style={{ height: `${barPx}px`, background: isPeak ? BRAND.seaGreen : BRAND.blue }}
                          title={`${b.range}: ${b.days} วัน`}
                        />
                        <div className="histogram-range-label">{b.range}</div>
                      </div>
                    );
                  });
                })()}
              </div>
            </section>
          </div>

          <div className="grid-container grid-cols-2">
            <section className="card">
              <h2 className="section-title">ค่าสถิติพื้นฐาน (ฟอง/ชั่วโมง)</h2>
              <table className="data-table">
                <tbody>
                  {basicStats.map((r, i) => (
                    <tr key={i}>
                      <td style={{color: '#475569'}}>{r.k}</td>
                      <td className="text-right" style={{fontWeight: 700}}>{r.v}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="table-interpretation">
                <p><span className="font-semibold">การตีความ:</span> Median (35,432) สะท้อน "วันปกติ" ที่สุด Base Case 36,000 จึงเป็นเป้าหมายที่ท้าทายแต่สมเหตุสมผล</p>
              </div>
            </section>

            <section className="card">
              <h2 className="section-title">ผลกระทบของ Loss Time</h2>
              <table className="data-table">
                <thead><tr><th>Loss Time/วัน</th><th className="text-center">Perf. เฉลี่ย</th><th className="text-center">ผลผลิต (ฟอง/ชม.)</th></tr></thead>
                <tbody>
                  {lossImpact.map((r, i) => (
                    <tr key={i}><td>{r.range}</td><td className="text-center" style={{color: '#475569'}}>{r.perf}</td><td className="text-center" style={{fontWeight: 700}}>{r.production}</td></tr>
                  ))}
                </tbody>
              </table>
              <p className="table-interpretation"><span className="font-semibold">สรุป:</span> ทุก 15 นาทีของ Loss Time จะลด Performance ลงประมาณ 2%</p>
            </section>
          </div>

          <section className="card">
            <h2 className="section-title">Scenarios & คำแนะนำ</h2>
            <div style={{overflowX: 'auto'}}>
              <table className="data-table scenario-table">
                <thead><tr><th>Scenario</th><th className="text-center">Target (ฟอง/ชม.)</th><th>เงื่อนไข</th><th className="text-center">ความเสี่ยง</th><th>การกระทำ</th></tr></thead>
                <tbody>
                  {scenarios.map((s, i) => (
                    <tr key={i} onClick={() => setSelected(s)} className={s.title.startsWith('Base Case') ? 'scenario-table-base-case' : ''}>
                      <td>{s.title}</td><td className="text-center">{s.target}</td><td>{s.condition}</td><td className="text-center">{s.risk}</td><td>{s.action}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <p style={{fontSize: '0.875rem', color: '#475569', marginTop: '1rem', textAlign: 'center'}}>คลิกที่แถวเพื่อดูรายละเอียดเพิ่มเติม</p>
          </section>
        </div>
      </main>

      {selected && <ScenarioModal scenario={selected} onClose={() => setSelected(null)} />}
    </div>
  );
}

